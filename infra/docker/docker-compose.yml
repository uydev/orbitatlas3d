version: '3.9'
services:
  db:
    image: postgis/postgis:16-3.4
    platform: linux/amd64
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: orbit
    ports: ["55432:5432"]
    healthcheck: { test: ["CMD-SHELL","pg_isready -U postgres"], interval: 5s, timeout: 5s, retries: 10 }
    volumes: [dbdata:/var/lib/postgresql/data]

  cache:
    image: redis:7-alpine
    ports: ["6379:6379"]

  api:
    build:
      context: ../..
      dockerfile: infra/docker/api.Dockerfile
    environment:
      DATABASE_URL: postgresql://postgres:postgres@db:5432/orbit
      REDIS_URL: redis://cache:6379/0
      HTTPS_PROXY: ""
      HTTP_PROXY: ""
      CELESTRAK_VERIFY_SSL: "false"
      NO_PROXY: ${NO_PROXY:-localhost,127.0.0.1,api,db,cache,celestrak.org,celestrak.com}
      SPACE_TRACK_USERNAME: ${SPACE_TRACK_USERNAME:?Set SPACE_TRACK_USERNAME}
      SPACE_TRACK_PASSWORD: ${SPACE_TRACK_PASSWORD:?Set SPACE_TRACK_PASSWORD}
    depends_on: [db, cache]
    ports: ["8000:8000"]
    dns:
      - 8.8.8.8
      - 1.1.1.1

  web:
    build:
      context: ../..
      dockerfile: infra/docker/web.Dockerfile
      args:
        VITE_API_URL: http://localhost:8000
        # Set your token here or leave empty; code will skip terrain without it
        VITE_CESIUM_ION_TOKEN: ""
    depends_on: [api]
    ports: ["5173:80"]

volumes: { dbdata: {} }



