import { readFile } from "node:fs/promises";
import { test, expect } from "./test.js";
import { globbySync } from "globby";
import { dirname, join } from "path";
import { fileURLToPath } from "node:url";
import { basename } from "node:path";

const gallery = globbySync("packages/sandcastle/gallery/**/*.html");

const __dirname = dirname(fileURLToPath(import.meta.url));

/**
 * Build an in-memory representation of a standalone sandcastle page for use in the test
 *
 * @param {string} indexPath
 */
async function buildSandcastleStandalone(indexPath) {
  const dir = dirname(indexPath);
  const jsPath = join(dir, "main.js");

  const htmlFile = await readFile(indexPath, "utf-8");
  let jsFile = await readFile(jsPath, "utf-8");

  if (jsFile.indexOf("import Sandcastle") < 0) {
    jsFile += 'import Sandcastle from "./Sandcastle.js"';
  }

  let scaffold = await readFile(
    join(__dirname, "sandcastle-scaffold.html"),
    "utf-8",
  );

  scaffold = scaffold.replace("<!-- SANDCASTLE_BODY -->", htmlFile);
  scaffold = scaffold.replace("// SANDCASTLE_CODE", jsFile);

  return scaffold;
}

for (const example of gallery) {
  const slug = basename(dirname(example));

  test(`${slug} renders`, async ({ page }) => {
    test.setTimeout(100000);

    const sandcastlePage = await buildSandcastleStandalone(example);

    // serve the new page at a fake route to fully mimic loading the page
    const fakePageRoute = `/${slug}-wrapper.html`;
    await page.route(fakePageRoute, (route) =>
      route.fulfill({
        status: 200,
        body: sandcastlePage,
      }),
    );
    await page.goto(fakePageRoute);

    await page.clock.pauseAt(new Date("2023-12-25T14:00:00"));

    await page.waitForLoadState("networkidle");

    await page.clock.runFor(1000);
    await page.clock.runFor(1000);
    await page.clock.runFor(1000);

    await expect(page).toHaveScreenshot({
      timeout: 20000,
    });
  });
}
